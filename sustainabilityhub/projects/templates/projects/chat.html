{% extends 'base.html' %}

{% block title %}Project Chat - {{ project.title }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div>
            <h1 style="margin: 0; color: var(--accent-2);">ðŸ’¬ {{ project.title }} Chat</h1>
            <p style="color: var(--muted); margin: 0.5rem 0 0 0; font-size: 0.9rem;">Private chat room for project members</p>
        </div>
        <a href="{% url 'projects:detail' pk=project.pk %}" class="btn btn-secondary">Back to Project</a>
    </div>
    
    <div id="chat-messages" style="height: 500px; overflow-y: auto; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 12px; margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
        {% for message in messages %}
            <div style="display: flex; gap: 0.75rem; {% if message.sender == user %}flex-direction: row-reverse;{% endif %}">
                <div>
                    {% if message.sender.avatar %}
                        <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.username }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                    {% else %}
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            {{ message.sender.username|first|upper }}
                        </div>
                    {% endif %}
                </div>
                <div style="flex: 1; {% if message.sender == user %}text-align: right;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; {% if message.sender == user %}justify-content: flex-end;{% endif %}">
                        <a href="{% url 'profiles:detail' username=message.sender.username %}" style="color: var(--accent-2); text-decoration: none; font-weight: 600; font-size: 0.9rem;">{{ message.sender.username }}</a>
                        <span style="color: var(--muted); font-size: 0.8rem;">{{ message.created_at|date:"H:i" }}</span>
                    </div>
                    <div style="padding: 0.75rem 1rem; background: {% if message.sender == user %}rgba(45,134,89,0.2){% else %}rgba(255,255,255,0.05){% endif %}; border-radius: 12px; display: inline-block; max-width: 70%;">
                        <p style="margin: 0; color: rgba(255,255,255,0.9); line-height: 1.5;">{{ message.content|linebreaks }}</p>
                    </div>
                </div>
            </div>
        {% empty %}
            <div style="text-align: center; padding: 2rem; color: var(--muted);">
                <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">No messages yet</p>
                <p>Start the conversation!</p>
            </div>
        {% endfor %}
    </div>
    
    {% if is_member %}
        <form method="post" action="{% url 'projects:chat_send' pk=project.pk %}" id="chat-form">
            {% csrf_token %}
            <div style="display: flex; gap: 0.75rem;">
                <input type="text" name="content" id="message-input" placeholder="Type your message..." required
                       style="flex: 1; padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.9); font-size: 0.95rem;">
                <button type="submit" class="btn" style="padding: 0.75rem 1.5rem;">Send</button>
            </div>
        </form>
    {% else %}
        <div style="padding: 1.5rem; text-align: center; color: var(--muted); border-top: 1px solid rgba(255,255,255,0.1);">
            <p>You must be a member of this project to participate in the chat.</p>
        </div>
    {% endif %}
</div>

<script>
    // Auto-scroll to bottom on load
    const chatMessages = document.getElementById('chat-messages');
    if(chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Auto-refresh messages every 5 seconds
    setInterval(function() {
        if(document.getElementById('chat-messages')) {
            location.reload();
        }
    }, 5000);
    
    // Focus message input on load
    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById('message-input');
        if(messageInput) {
            messageInput.focus();
        }
    });
</script>
{% endblock %}

